<!doctype html>
<html>
<head>
  <title>Freeflow Job Viewer</title>
  <style>
    #map {
      height: 100%;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .fleet-view-marker-icon {
      width: 36px;
      height: 36px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: 50%;
      transform-origin: center;
    }
    .star-icon {
      width: 48px;
      height: 48px;
      background-size: contain;
      background-repeat: no-repeat;
    }
    .custom-info-window {
      font-family: Arial, sans-serif;
      font-size: 12px;
      line-height: 1.4em;
      padding: 5px;
      width: 250px;
      overflow-x: hidden;
    }
    .custom-info-window strong {
      font-size: 14px;
    }
    .custom-info-window img {
      margin-top: 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .label-container {
      position: absolute;
      transform: translate(-50%, 8px);
      background-color: rgba(255, 255, 255, 0.8);
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 10px;
      color: #000;
      font-family: Arial, sans-serif;
      white-space: nowrap;
      z-index: 10000;
    }
  </style>
  <script>
    let map;
    let jobMarkers = [];
    let vehicleMarkers = {};
    let unscheduledJobMarkers = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: { lat: 42.182020, lng: -72.515020 },
        mapId: "64c9800e01e9e346",
        disableDefaultUI: true,
      });

      const trafficLayer = new google.maps.TrafficLayer();
      const bounds = new google.maps.LatLngBounds();
      const boundsValue = (new URL(location.href)).searchParams.get('show');
      trafficLayer.setMap(map);

      fetchJobData(bounds, boundsValue);
      fetchVehicleData();
      fetchUnscheduledJobData();

      setInterval(() => {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        if ((hours > 5 || (hours === 5 && minutes >= 30)) && hours < 22) {
          fetchJobData(bounds, boundsValue);
          fetchUnscheduledJobData();
        }
      }, 600000);

      setInterval(() => {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        if ((hours > 5 || (hours === 5 && minutes >= 30)) && hours < 22) {
          fetchVehicleData();
        }
      }, 15000);
    }

    function fetchJobData(bounds, boundsValue) {
      $.getJSON("https://hook.us1.make.com/0ovk9hp1ev25shv9nampbn1ulhgscj4p")
        .done(function(data) {
          jobMarkers.forEach(marker => marker.setMap(null));
          jobMarkers = [];

          data.forEach(function(data) {
            const myLatlng = new google.maps.LatLng(data.Lat, data.Lng);
            const myPin = getPin(data);
            const marker = new google.maps.marker.AdvancedMarkerElement({
              map,
              position: myLatlng,
              title: `${data.JobID} | ${data.LocationName} | ${data.Status}`,
              content: myPin.element,
            });

            const techsAssigned = data.Techs ? data.Techs.map(tech => `${tech.first_name} ${tech.last_name}`).join(', ') : '';
            const infoContent = `
              <div class="custom-info-window">
                <small><em>${data.Category}</em></small><br />
                <strong>Job ${data.JobID} / Work Order ${data.PONumber}</strong>
                <p><strong>${data.Customer}<br />${data.LocationName}</strong><br />${data.Address}</p>
                <p>Tech/s Assigned: ${techsAssigned}</p>
                <p><strong><a href="${data.SFURL}" target="_blank">View Job in Service Fusion</a></strong></p>
              </div>
            `;
            const infoWindow = new google.maps.InfoWindow({ content: infoContent });
            google.maps.event.addListener(marker, 'click', function() {
              infoWindow.open(map, marker);
            });
            jobMarkers.push(marker);
            bounds.extend(myLatlng);
            if (boundsValue === 'all') {
              map.fitBounds(bounds);
            }
          });
        })
        .fail(function() {
          console.log("Error fetching job data.");
        });
    }

    function fetchVehicleData() {
      const workerApiUrl = 'https://get-motive-details.daniel-ff2.workers.dev/?vehicleId=';

      $.ajax({
        url: 'https://motive-vehicles.daniel-ff2.workers.dev/',
        method: 'GET',
        success: function(data) {
          data.vehicles.forEach(vehicleData => {
            const vehicle = vehicleData.vehicle;
            const position = new google.maps.LatLng(vehicle.current_location.lat, vehicle.current_location.lon);
            const isMoving = vehicle.current_location.speed !== null && vehicle.current_location.speed > 0;
            const markerIconUrl = isMoving ? 'moving-street.svg' : (vehicle.current_location.speed === 0 ? 'stationary-street.svg' : 'idle-street.svg');

            let marker = vehicleMarkers[vehicle.id];

            const markerIconContainer = createVehicleMarkerContent(markerIconUrl, isMoving, vehicle.current_location.bearing);

            if (marker) {
              marker.position = position;
              marker.content = markerIconContainer;
            } else {
              const markerContent = document.createElement('div');
              markerContent.appendChild(markerIconContainer);

              // Create and append the label below the marker
              const labelContainer = document.createElement('div');
              labelContainer.className = 'label-container';
              labelContainer.innerText = `${vehicle.number} ${vehicle.current_driver ? vehicle.current_driver.first_name : ''}`;
              markerContent.appendChild(labelContainer);

              marker = new google.maps.marker.AdvancedMarkerElement({
                map,
                position,
                content: markerContent,
                title: vehicle.number,
                zIndex: 9999
              });

              let infoContent = `
                <div class="custom-info-window">
                  <strong>Vehicle ${vehicle.number}</strong><br />${vehicle.make} ${vehicle.model} (${vehicle.year})<br />${vehicle.current_location.description}
                  <br /><strong>Speed:</strong> ${vehicle.current_location.speed !== null ? vehicle.current_location.speed + ' mph' : 'N/A'}
                  <br /><strong>Odometer:</strong> ${vehicle.current_location.odometer !== null ? vehicle.current_location.odometer.toFixed(1) + ' miles' : 'N/A'}
                  <br /><strong>Primary Fuel Remaining:</strong> ${vehicle.current_location.fuel_primary_remaining_percentage !== null ? vehicle.current_location.fuel_primary_remaining_percentage + '%' : 'N/A'}
                  ${vehicle.current_driver ? `<br /><strong>Driver:</strong> ${vehicle.current_driver.first_name} ${vehicle.current_driver.last_name}` : ''}
                  <br /><strong><a href="https://app.gomotive.com/en-US/#/fleetview/map/vehicle/${vehicle.id}-null-null/${vehicle.id}/live" target="_blank">View Vehicle on Motive</a></strong>
                </div>
              `;

              const infoWindow = new google.maps.InfoWindow({ content: infoContent });

              marker.addListener('click', function() {
                $.getJSON(workerApiUrl + vehicle.id, function(response) {
                  const imageUrl = response.front_facing_image_url;
                  const driverImageUrl = response.driver_facing_image_url;
                  const driverName = response.last_known_driver;

                  let imageHtml = '';
                  if (imageUrl) {
                    imageHtml += `<br /><a href="${imageUrl}" target="_blank"><img src="${imageUrl}" alt="Front Vehicle Image" style="width: 200px; height: auto;"></a>`;
                  }
                  if (driverImageUrl) {
                    imageHtml += `<br /><a href="${driverImageUrl}" target="_blank"><img src="${driverImageUrl}" alt="Driver Facing Image" style="width: 200px; height: auto;"></a>`;
                  }
                  const updatedContent = `<div class="custom-info-window">` + infoContent + `<br /><strong>Last Known Driver:</strong> ${driverName}` + imageHtml + `</div>`;

                  infoWindow.setContent(updatedContent);
                  infoWindow.open(map, marker);
                })
                .fail(function() {
                  console.log("Error fetching additional vehicle data.");
                  infoWindow.open(map, marker);
                });
              });

              vehicleMarkers[vehicle.id] = marker;
            }
          });
        },
        error: function(xhr,
