<!doctype html>
<html>
<head>
  <title>Freeflow Job Viewer</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <style>
    #map {
      height: 100%;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>
    function initMap() {
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: { lat: 42.182020, lng: -72.515020 },
        mapId: "FREEFLOW",
        disableDefaultUI: true,
      });
      const trafficLayer = new google.maps.TrafficLayer();
      const bounds = new google.maps.LatLngBounds();
      const boundsValue = (new URL(location.href)).searchParams.get('show');
      trafficLayer.setMap(map);

      fetchJobData(map, bounds, boundsValue);
      fetchVehicleData(map);
    }

    function fetchJobData(map, bounds, boundsValue) {
      $.getJSON("https://hook.us1.make.com/0ovk9hp1ev25shv9nampbn1ulhgscj4p")
        .done(function(data) {
          data.forEach(function(data) {
            const myLatlng = new google.maps.LatLng(data.Lat, data.Lng);
            const myPin = getPin(data);
            const marker = new google.maps.marker.AdvancedMarkerElement({
              map,
              position: myLatlng,
              title: `${data.JobID} | ${data.LocationName} | ${data.Status}`,
              content: myPin.element,
            });
            const techsAssigned = data.Techs ? data.Techs.map(tech => `${tech.first_name} ${tech.last_name}`).join(', ') : '';
            const infoContent = `
              <small><em>${data.Category}</em></small><br /><br />
              <strong>Job ${data.JobID} / Work Order ${data.PONumber}</strong>
              <p><strong>${data.Customer}<br />${data.LocationName}</strong><br />${data.Address}</p>
              <p>Tech/s Assigned: ${techsAssigned}</p>
              <p><strong><a href="${data.SFURL}" target="_blank">View Job in Service Fusion</a></p>
            `;
            marker.info = new google.maps.InfoWindow({ content: infoContent });
            google.maps.event.addListener(marker, 'click', function() {
              marker.info.open(map, marker);
            });
            bounds.extend(myLatlng);
            if (boundsValue === 'all') {
              map.fitBounds(bounds);
            }
          });
        })
        .fail(function() {
          alert("Error fetching job data.");
        });
    }

    function fetchVehicleData(map) {
      const apiUrl = 'https://api.keeptruckin.com/v2/vehicle_locations?vehicle_ids=1713181&per_page=25&page_no=1';
      fetch(apiUrl, {
        headers: {
          'X-Api-Key': '81e4c2dd-f33a-4ab7-97db-2d3fea1a19b4',
          'accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        data.vehicles.forEach(vehicleData => {
          const vehicle = vehicleData.vehicle;
          const location = vehicle.current_location;
          const position = new google.maps.LatLng(location.lat, location.lon);
          const marker = new google.maps.Marker({
            position,
            map,
            title: vehicle.number,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: '#FF0000',
              fillOpacity: 0.8,
              strokeWeight: 2,
              strokeColor: '#FFFFFF'
            }
          });
          let infoContent = `<strong>Vehicle ${vehicle.number}</strong><br />${vehicle.make} ${vehicle.model} (${vehicle.year})<br />${location.description}`;
          if (vehicle.current_driver) {
            infoContent += `<br /><strong>Driver:</strong> ${vehicle.current_driver.first_name} ${vehicle.current_driver.last_name}`;
          }
          const infoWindow = new google.maps.InfoWindow({ content: infoContent });
          marker.addListener('click', function() {
            infoWindow.open(map, marker);
          });
        });
      })
      .catch(error => {
        alert("Error fetching vehicle data.");
        console.error('Error:', error);
      });
    }

    function getPin(data) {
      const statusColors = {
        'Scheduled': '#6fdb6b',
        'Dispatched': '#30962d',
        'On The Way': '#a6d2e3',
        'Started': '#21586e',
        'Work Completed': '#e30035',
        'Parts Review': '#e30035',
        'Service Review': '#e30035',
        'Sales Review': '#e30035',
        'Management Review': '#e30035',
        'Clerical Review': '#e30035',
        'Return Required': '#ff7214',
        'Ready for Redispatch': '#ff7214',
        'Parts Needed': '#f0e62d',
        'Waiting for Parts': '#f0e62d',
        'Ready for Invoicing': '#962c88',
        'Invoiced': '#962c88',
        'Invoice Created': '#962c88',
        'default': '#999999',
      };
      const categoryColors = {
        'On-Site Installation Service': '#03a9f4',
        'On-Site Reactive Service': '#e30035',
        'default': '#ab47bc',
      };
      const priorityColors = {
        'High': '#e30035',
        'Low': '#03a9f4',
        'default': '#000',
      };
      const bgColor = statusColors[data.Status] || statusColors['default'];
      const glpColor = categoryColors[data.Category] || categoryColors['default'];
      const brdColor = priorityColors[data.Priority] || priorityColors['default'];
      return new google.maps.marker.PinElement({ background: bgColor, glyphColor: glpColor, borderColor: brdColor, scale: 1.4 });
    }

    window.initMap = initMap;
  </script>
</head>
<body>
  <div id="map"></div>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-qJKroH3C4kpTx2coecp-CZ6tTnzYhXA&callback=initMap&v=weekly&libraries=marker" defer></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
</body>
</html>
