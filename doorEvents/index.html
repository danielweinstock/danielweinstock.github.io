<!DOCTYPE html>
<html lang="en">
<head>
  <title>Freeflow Beverage Solutions - Digital Signage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <!-- React, ReactDOM, Firebase -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-database-compat.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&family=Poppins:wght@200;300;400;500;600;700&display=swap');
    
    :root {
      --kelly-green: #00a651;
      --dark-green: #007a3d;
      --black: #000000;
      --white: #ffffff;
      --light-gray: #f5f5f5;
      --dark-gray: #333333;
      --bodyFontFamily: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      --titleFontFamily: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      --alert-red: #ff4444;
      --warning-orange: #ff8800;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--bodyFontFamily);
      height: 100vh;
      width: 100vw;
      background: linear-gradient(135deg, var(--kelly-green) 0%, var(--dark-green) 50%, var(--black) 100%);
      color: var(--white);
      overflow: hidden;
    }

    .content-container, .idle-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      position: relative;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
    }

    .content-container.fade-in,
    .idle-container.fade-in {
      opacity: 1;
    }

    .content-container.fade-out,
    .idle-container.fade-out {
      opacity: 0;
    }

    /* Header Section */
    .header-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border-bottom: 3px solid var(--kelly-green);
      min-height: 100px;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-placeholder {
      width: 70px;
      height: 70px;
      background: var(--white);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--kelly-green);
      font-size: 0.7rem;
      text-align: center;
      line-height: 1.2;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .company-name {
      font-family: var(--titleFontFamily);
      font-size: 2rem;
      font-weight: 600;
      color: var(--white);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .welcome-text {
      font-family: var(--titleFontFamily);
      font-size: 1.6rem;
      font-weight: 400;
      color: var(--kelly-green);
      opacity: 0.9;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* Idle Screen Styles */
    .idle-container {
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .idle-greeting {
      font-size: 4.5rem;
      margin-bottom: 3rem;
      color: var(--white);
      font-weight: 300;
      font-family: var(--titleFontFamily);
      letter-spacing: -0.02em;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .clock-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .time {
      font-size: 4rem;
      font-weight: 200;
      color: var(--kelly-green);
      font-family: var(--titleFontFamily);
      letter-spacing: -0.01em;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .date {
      font-size: 2rem;
      font-weight: 300;
      color: var(--white);
      font-family: var(--bodyFontFamily);
      opacity: 0.8;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    /* Welcome Screen Styles */
    .welcome-large {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex-grow: 1;
      text-align: center;
    }

    .welcome-title {
      font-size: 3.5rem;
      font-weight: 300;
      margin-bottom: 1.5rem;
      color: var(--white);
      font-family: var(--titleFontFamily);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .welcome-name {
      font-size: 6rem;
      font-weight: 600;
      color: var(--kelly-green);
      font-family: var(--titleFontFamily);
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      line-height: 1.1;
    }

    /* Content Screen Styles */
    .content-body {
      flex-grow: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .section {
      margin-bottom: 3rem;
    }

    .section-title {
      font-size: 2.5rem;
      font-weight: 600;
      color: var(--kelly-green);
      margin-bottom: 2rem;
      font-family: var(--titleFontFamily);
      display: flex;
      align-items: center;
      gap: 1rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .section-icon {
      width: 40px;
      height: 40px;
      background: var(--kelly-green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      color: var(--white);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Job Cards */
    .job-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      margin-bottom: 2rem;
      overflow: hidden;
      border: 2px solid rgba(0, 166, 81, 0.3);
      transition: all 0.3s ease;
      backdrop-filter: blur(15px);
      opacity: 0;
      transform: translateX(-80px);
      animation: slideInFromLeft 0.8s ease-out forwards;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .job-card:nth-child(even) {
      transform: translateX(80px);
      animation: slideInFromRight 0.8s ease-out forwards;
    }

    .job-card:nth-child(2) { animation-delay: 0.2s; }
    .job-card:nth-child(3) { animation-delay: 0.4s; }
    .job-card:nth-child(4) { animation-delay: 0.6s; }
    .job-card:nth-child(5) { animation-delay: 0.8s; }
    .job-card:nth-child(6) { animation-delay: 1.0s; }

    .job-card-content {
      display: flex;
      height: 100%;
      min-height: 120px;
    }

    .job-time-bar {
      width: 90px;
      background: linear-gradient(135deg, var(--kelly-green), var(--dark-green));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem 0;
      position: relative;
    }

    .job-time {
      writing-mode: vertical-lr;
      text-orientation: mixed;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--white);
      text-align: center;
      transform: rotate(180deg);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      letter-spacing: 0.5px;
    }

    .job-details {
      flex: 1;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.05);
    }

    .job-customer {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--white);
      margin-bottom: 0.8rem;
      font-family: var(--titleFontFamily);
    }

    .job-location {
      font-size: 1.3rem;
      color: var(--white);
      opacity: 0.8;
      margin-bottom: 1rem;
      font-weight: 300;
    }

    .job-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .job-number {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--white);
      background: var(--kelly-green);
      padding: 0.5rem 1rem;
      border-radius: 25px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .job-category {
      font-size: 1.2rem;
      color: var(--white);
      opacity: 0.7;
      font-weight: 400;
    }

    .job-status {
      font-size: 1.2rem;
      color: var(--kelly-green);
      opacity: 0.9;
      font-weight: 500;
    }

    /* Parts Transfer Cards */
    .parts-card {
      background: rgba(255, 136, 0, 0.15);
      border: 3px solid var(--warning-orange);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(15px);
      opacity: 0;
      transform: translateY(-50px);
      animation: slideInFromTop 0.8s ease-out forwards;
      box-shadow: 0 8px 32px rgba(255, 136, 0, 0.2);
    }

    .parts-card:nth-child(2) { animation-delay: 0.2s; }
    .parts-card:nth-child(3) { animation-delay: 0.4s; }

    .parts-description {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--white);
      margin-bottom: 0.8rem;
      font-family: var(--titleFontFamily);
    }

    .parts-job {
      font-size: 1.3rem;
      color: var(--warning-orange);
      font-weight: 600;
      margin-bottom: 0.8rem;
    }

    .parts-notes {
      font-size: 1.2rem;
      color: var(--white);
      opacity: 0.8;
      font-style: italic;
      line-height: 1.4;
    }

    /* Messages Cards */
    .message-card {
      background: rgba(0, 166, 81, 0.2);
      border: 3px solid var(--kelly-green);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(15px);
      display: flex;
      align-items: center;
      gap: 1.5rem;
      opacity: 0;
      transform: translateX(80px);
      animation: slideInFromRight 0.8s ease-out forwards;
      box-shadow: 0 8px 32px rgba(0, 166, 81, 0.2);
    }

    .message-card:nth-child(2) { animation-delay: 0.2s; }
    .message-card:nth-child(3) { animation-delay: 0.4s; }

    .message-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--kelly-green);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: var(--white);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }

    .message-text {
      font-size: 1.4rem;
      font-weight: 500;
      color: var(--white);
      flex: 1;
      line-height: 1.4;
    }

    /* Animations */
    @keyframes slideInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-80px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInFromRight {
      from {
        opacity: 0;
        transform: translateX(80px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInFromTop {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 8px 32px rgba(255, 68, 68, 0.3);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 12px 40px rgba(255, 68, 68, 0.5);
      }
    }

    .pulse-animation {
      animation: pulse 2s infinite;
    }

    /* Alert Styles */
    .parts-alert {
      background: var(--alert-red);
      color: var(--white);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      font-weight: 600;
      text-align: center;
      font-size: 1.4rem;
      animation: pulse 1.5s infinite;
      box-shadow: 0 4px 16px rgba(255, 68, 68, 0.4);
    }

    /* Responsive Design for Portrait Mode */
    @media screen and (max-width: 768px) and (orientation: portrait) {
      .header-section {
        padding: 1rem;
        min-height: 80px;
      }
      
      .company-name {
        font-size: 1.6rem;
      }
      
      .welcome-text {
        font-size: 1.2rem;
      }
      
      .idle-greeting {
        font-size: 3.5rem;
      }
      
      .time {
        font-size: 3rem;
      }
      
      .date {
        font-size: 1.6rem;
      }
      
      .welcome-name {
        font-size: 4rem;
      }
      
      .job-time-bar {
        width: 70px;
      }
      
      .job-time {
        font-size: 1rem;
      }
      
      .job-customer {
        font-size: 1.5rem;
      }
      
      .section-title {
        font-size: 2rem;
      }

      .content-body {
        padding: 1rem;
      }
    }

    /* No Jobs Message */
    .no-jobs {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--white);
      opacity: 0.7;
      font-size: 1.6rem;
      font-weight: 300;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
    }

    /* Setup screen styles */
    .setup-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: var(--bodyFontFamily);
      z-index: 9999;
      text-align: center;
      padding: 2rem;
    }

    .setup-screen h1 {
      font-size: 3rem;
      margin-bottom: 2rem;
      color: var(--kelly-green);
      font-family: var(--titleFontFamily);
    }

    .setup-screen p {
      font-size: 1.5rem;
      margin-bottom: 3rem;
      color: var(--white);
    }

    .setup-button {
      margin: 1rem;
      padding: 1.5rem 3rem;
      font-size: 1.3rem;
      background: var(--kelly-green);
      color: var(--white);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .setup-button:hover {
      background: var(--dark-green);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body>
  <div id="root"></div>

<script>
  const e = React.createElement;
  const useState = React.useState;
  const useEffect = React.useEffect;

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "freeflow-internal-projects.firebaseapp.com",
    databaseURL: "https://freeflow-internal-projects-default-rtdb.firebaseio.com",
    projectId: "freeflow-internal-projects",
    storageBucket: "freeflow-internal-projects.appspot.com",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  let db = null;
  
  // Initialize Firebase if available
  if (typeof firebase !== 'undefined') {
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization failed:', error);
    }
  } else {
    console.warn('Firebase not available - running in demo mode');
  }

  let fadeTimeout = null;
  let idleTimeout = null;
  let clockInterval = null;
  let currentScreenId = null;
  let dashboardTimeout = null;

  function getScreenIdentifier() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('screenId')) return urlParams.get('screenId');
    const storedScreenId = localStorage.getItem('screencloudScreenId');
    if (storedScreenId) return storedScreenId;
    return null;
  }

  function playPartsAlert() {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 1);
    } catch (error) {
      console.log('Audio not supported');
    }
  }

  function getTimeBasedGreeting() {
    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) return "Good Morning";
    if (hour >= 12 && hour < 17) return "Good Afternoon";
    if (hour >= 17 && hour < 21) return "Good Evening";
    return "Good Night";
  }

  function formatTime() {
    return new Date().toLocaleTimeString([], { 
      hour: 'numeric', 
      minute: '2-digit', 
      hour12: true 
    });
  }

  function formatDate() {
    return new Date().toLocaleDateString([], { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
  }

  function formatJobTime(startMin) {
    if (!startMin) return '';
    const mins = parseInt(startMin, 10);
    const hours = Math.floor(mins / 60);
    const minutes = mins % 60;
    const period = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
    return displayHours + ':' + minutes.toString().padStart(2, '0') + ' ' + period;
  }

  function getFirstName(data) {
    // Use the new payload structure
    if (data && data.user_fname) return data.user_fname;
    if (data && data.fname) return data.fname;
    if (data && data.user) return data.user.split(' ')[0];
    return 'Guest';
  }

  function IdleMessage() {
    const [time, setTime] = useState(formatTime());
    const [date, setDate] = useState(formatDate());

    useEffect(function() {
      const interval = setInterval(function() {
        setTime(formatTime());
        setDate(formatDate());
      }, 1000);
      return function() { clearInterval(interval); };
    }, []);

    return e('div', { className: 'idle-container fade-in' },
      e('h1', { className: 'idle-greeting' }, getTimeBasedGreeting()),
      e('div', { className: 'clock-container' },
        e('div', { className: 'time' }, time),
        e('div', { className: 'date' }, date)
      )
    );
  }

  function WelcomeMessage(props) {
    const data = props.data;
    const name = data ? (data.name || data.user || "Guest") : "Guest";
    return e('div', { className: 'content-container fade-in' },
      e('div', { className: 'header-section' },
        e('div', { className: 'logo-container' },
          e('div', { className: 'logo-placeholder' }, 'FREEFLOW\nLOGO'),
          e('div', { className: 'company-name' }, 'Freeflow Beverage Solutions')
        ),
        e('div', { className: 'welcome-text' }, 'Welcome ' + userFirstName)
      ),
      e('div', { className: 'content-body' }, contentElements)
    );
  }

  function SetupScreen() {
    function handleSetScreenId(screenId) {
      localStorage.setItem('screencloudScreenId', screenId);
      currentScreenId = screenId;
      console.log('Screen ID set to:', screenId);
      initializeApp();
    }

    return e('div', { className: 'setup-screen' },
      e('h1', null, 'Screen Setup Required'),
      e('p', null, 'Please select this screen\'s location:'),
      e('button', { 
        className: 'setup-button',
        onClick: function() { handleSetScreenId('front_door'); }
      }, 'Front Door'),
      e('button', { 
        className: 'setup-button',
        onClick: function() { handleSetScreenId('back_door'); }
      }, 'Back Door'),
      e('button', { 
        className: 'setup-button',
        onClick: function() { handleSetScreenId('side_entrance'); }
      }, 'Side Entrance'),
      e('button', { 
        className: 'setup-button',
        onClick: function() { handleSetScreenId('main_lobby'); }
      }, 'Main Lobby')
    );
  }

  function showIdleMessage() {
    if (dashboardTimeout) clearTimeout(dashboardTimeout);
    ReactDOM.render(e(IdleMessage), document.getElementById("root"));
  }

  function renderWelcome(data) {
    ReactDOM.render(e(WelcomeMessage, { data: data }), document.getElementById("root"));
    if (fadeTimeout) clearTimeout(fadeTimeout);
    if (idleTimeout) clearTimeout(idleTimeout);
    if (clockInterval) clearInterval(clockInterval);
  }

  function renderDashboard(dashboard, timeout) {
    ReactDOM.render(e(Dashboard, { dashboard: dashboard }), document.getElementById("root"));
    if (fadeTimeout) clearTimeout(fadeTimeout);
    if (idleTimeout) clearTimeout(idleTimeout);
    if (clockInterval) clearInterval(clockInterval);
    dashboardTimeout = setTimeout(showIdleMessage, timeout || 35000);
  }

  function setupScreenId() {
    ReactDOM.render(e(SetupScreen), document.getElementById("root"));
  }

  function isMessageForThisScreen(data) {
    if (!data.targetScreen) return true;
    if (data.targetScreen === currentScreenId) return true;
    if (data.targetScreenName && currentScreenId) return false;
    return false;
  }

  function initializeApp() {
    showIdleMessage();

    // Only set up Firebase listener if Firebase is available
    if (db) {
      db.ref('doorEvents').limitToLast(1).on('child_added', async function(snapshot) {
        const data = snapshot.val();
        console.log('Inbound RTDB event data:', data);
        
        if (!isMessageForThisScreen(data)) {
          console.log('Message not for this screen, ignoring');
          return;
        }

        // Extract user info from new payload structure
        const firstName = data.user_fname || data.fname || '';
        const lastName = data.user_lname || data.lname || '';
        const fullName = data.user || (firstName + ' ' + lastName).trim() || "Guest";
        const eventType = data.event || "entry";
        const timeout = data.timeout || 30000;
        const eventData = Object.assign({}, data, { 
          user_fname: firstName,
          user_lname: lastName,
          user: fullName,
          eventType: eventType, 
          timeout: timeout 
        });

        renderWelcome(eventData);

        if (data.sf_id) {
          try {
            const resp = await fetch('https://hook.us1.make.celonis.com/t3yygxqt3ir6ybqo4uyms9d9gaahasxg?sf_id=' + encodeURIComponent(data.sf_id));
            if (resp.ok) {
              const dashboard = await resp.json();
              // Pass the user payload to dashboard
              dashboard.userPayload = eventData;
              setTimeout(function() {
                renderDashboard(dashboard, 35000);
              }, 1500);
            } else {
              console.error('Failed to fetch dashboard data');
              setTimeout(showIdleMessage, timeout);
            }
          } catch (e) {
            console.error("Error fetching dashboard from Make.com:", e);
            setTimeout(showIdleMessage, timeout);
          }
        } else {
          setTimeout(showIdleMessage, timeout);
        }
      });
      console.log('App initialized with Firebase, waiting for data pushes...');
    } else {
      console.log('App initialized without Firebase - demo mode');
      
      // Demo mode - simulate a door event after 5 seconds for testing
      setTimeout(function() {
        const demoData = {
          user: "Daniel Weinstock",
          user_fname: "Daniel",
          user_lname: "Weinstock", 
          sf_id: "demo_id",
          event: "entry",
          timeout: 30000,
          door: "Freeflow Office",
          emp_id: "demo-emp-id",
          timestamp: Math.floor(Date.now() / 1000)
        };
        renderWelcome(demoData);
        
        // Simulate dashboard data
        setTimeout(function() {
          const demoDashboard = {
            userPayload: demoData,
            dispatch: {
              ASSIGNED: {
                tech1: {
                  job1: {
                    jobNumber: "12345",
                    jobStartDate: "2025-07-10",
                    startMin: 540,
                    customerName: "ABC Beverage Co",
                    city_state: "Boston, MA",
                    postal_code: "02101",
                    job_category: "Installation",
                    jobStatusName: "Scheduled"
                  }
                }
              }
            },
            parts_transfer: [
              {
                transfer_id: "pt1",
                description: "CO2 Regulator - Model XR500",
                job_number: "12345",
                notes: "Required for installation tomorrow"
              }
            ],
            messages: [
              {
                messageId: "msg1",
                message_text: "Remember to check equipment before departure"
              }
            ]
          };
          renderDashboard(demoDashboard, 35000);
        }, 1500);
      }, 5000);
    }
  }

  window.onload = function() {
    currentScreenId = getScreenIdentifier();
    if (currentScreenId) {
      console.log('Screen ID determined:', currentScreenId);
      initializeApp();
    } else {
      console.log('Screen ID not found, showing setup');
      setupScreenId();
    }
  };
</script>
</body>
</html>-in' },
      e('div', { className: 'welcome-large' },
        e('h2', { className: 'welcome-title' }, 'Welcome'),
        e('h1', { className: 'welcome-name' }, name)
      )
    );
  }

  function WelcomeMessage(props) {
    const data = props && props.data ? props.data : {};
    // Use the new payload structure with separate first/last names
    const firstName = data.user_fname || data.fname || '';
    const lastName = data.user_lname || data.lname || '';
    const fullName = data.user || (firstName + ' ' + lastName).trim() || "Guest";
    
    return e('div', { className: 'content-container fade-in' },
      e('div', { className: 'welcome-large' },
        e('h2', { className: 'welcome-title' }, 'Welcome'),
        e('h1', { className: 'welcome-name' }, fullName)
      )
    );
  }

  function JobCard(props) {
    const job = props && props.job ? props.job : {};
    const index = props && typeof props.index === 'number' ? props.index : 0;
    const animationDelay = (index * 0.2) + 's';
    
    return e('div', { 
      className: 'job-card',
      style: { animationDelay: animationDelay }
    },
      e('div', { className: 'job-card-content' },
        e('div', { className: 'job-time-bar' },
          e('div', { className: 'job-time' }, formatJobTime(job.startMin))
        ),
        e('div', { className: 'job-details' },
          e('div', { className: 'job-customer' }, job.customerName || job.customer_name || 'â€”'),
          e('div', { className: 'job-location' }, 
            [job.city_state, job.postal_code].filter(Boolean).join(' â€¢ ') || 'Location TBD'
          ),
          e('div', { className: 'job-meta' },
            e('div', { className: 'job-number' }, 'Job #' + (job.jobNumber || 'N/A')),
            e('div', { className: 'job-category' }, job.job_category || 'No category')
          ),
          e('div', { className: 'job-status' }, 
            'Status: ' + (job.jobStatusName || job.code || 'â€”')
          )
        )
      )
    );
  }

  function Dashboard(props) {
    const dashboard = props && props.dashboard ? props.dashboard : {};
    
    let jobs = [];
    if (dashboard.dispatch && dashboard.dispatch.ASSIGNED) {
      try {
        const allVisits = Object.values(dashboard.dispatch.ASSIGNED).flatMap(function(obj) {
          return Object.values(obj);
        });
        jobs = allVisits.filter(function(j) {
          return j && j.jobNumber && j.jobStartDate;
        }).map(function(j) {
          let date = j.jobStartDate;
          let mins = parseInt(j.startMin || 0, 10);
          let startSort = Number.MAX_SAFE_INTEGER;
          if (date && !isNaN(mins)) {
            let dateParts = date.split('-').map(function(x) { return parseInt(x, 10); });
            let year = dateParts[0];
            let month = dateParts[1];
            let day = dateParts[2];
            startSort = new Date(year, month - 1, day, Math.floor(mins / 60), mins % 60).getTime();
          }
          return Object.assign({}, j, { startSort: startSort });
        }).sort(function(a, b) {
          return a.startSort - b.startSort;
        });
      } catch (error) {
        console.error('Error processing jobs:', error);
        jobs = [];
      }
    }

    const parts = dashboard.parts_transfer || [];
    const messages = dashboard.messages || [];
    const userFirstName = getFirstName(dashboard.userPayload || dashboard);

    useEffect(function() {
      if (parts.length > 0) {
        playPartsAlert();
      }
    }, [parts.length]);

    const jobCards = jobs.length > 0 ? 
      jobs.map(function(job, index) {
        return e(JobCard, { job: job, index: index, key: (job.jobNumber || 'job') + '-' + index });
      }) : 
      [e('div', { className: 'no-jobs', key: 'no-jobs' }, 'No jobs scheduled for today.')];

    const partsCards = parts.length > 0 ? 
      parts.map(function(part, index) {
        const animationDelay = (index * 0.2) + 's';
        return e('div', {
          key: (part.transfer_id || 'part') + '-' + index,
          className: 'parts-card',
          style: { animationDelay: animationDelay }
        },
          e('div', { className: 'parts-description' }, part.description || 'Part description'),
          e('div', { className: 'parts-job' }, 'For Job: ' + (part.job_number || 'N/A')),
          part.notes ? e('div', { className: 'parts-notes' }, part.notes) : null
        );
      }) : [];

    const messageCards = messages.length > 0 ?
      messages.map(function(message, index) {
        const animationDelay = (index * 0.2) + 's';
        return e('div', {
          key: (message.messageId || 'message') + '-' + index,
          className: 'message-card',
          style: { animationDelay: animationDelay }
        },
          e('div', { className: 'message-icon' }, 'ðŸ“¢'),
          e('div', { className: 'message-text' }, message.message_text || 'No message text')
        );
      }) : [];

    const contentElements = [
      e('div', { className: 'section', key: 'jobs-section' },
        e('h2', { className: 'section-title' },
          e('div', { className: 'section-icon' }, 'ðŸ“…'),
          'Today\'s Schedule'
        ),
        jobCards
      )
    ];

    if (parts.length > 0) {
      contentElements.push(
        e('div', { className: 'section', key: 'parts-section' },
          e('div', { className: 'parts-alert' }, 'ðŸš¨ PARTS TRANSFER REQUIRED ðŸš¨'),
          e('h2', { className: 'section-title' },
            e('div', { className: 'section-icon' }, 'ðŸ“¦'),
            'Parts to Transfer'
          ),
          partsCards
        )
      );
    }

    if (messages.length > 0) {
      contentElements.push(
        e('div', { className: 'section', key: 'messages-section' },
          e('h2', { className: 'section-title' },
            e('div', { className: 'section-icon' }, 'ðŸ’¬'),
            'Messages'
          ),
          messageCards
        )
      );
    }

    return e('div', { className: 'content-container fade
